<div class="card card--no-line">
  <h1><%= @questionnaire.title %></h1>
  <p><%= @questionnaire.description %></p>
</div>

<%= render 'questionnaires/subnavbar' %>

<div class="card">
  <%= form_with(model: @questionnaire, url: questionnaire_questions_path(@questionnaire), method: :put) do |f| %>
    <div class="card" style="position: sticky; top: 20px; background-color: var(--surface-1); flex-flow: row;">
      <%= f.button class: "button", type: :button, data: { behaviour: 'add-question-form' }, style: "flex-grow: 3;" do %>
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M200-200v-160 4-4 160Zm0 80q-33 0-56.5-23.5T120-200v-160q0-33 23.5-56.5T200-440h560q33 0 56.5 23.5T840-360H200v160h400v80H200Zm0-400q-33 0-56.5-23.5T120-600v-160q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v160q0 33-23.5 56.5T760-520H200Zm0-80h560v-160H200v160Zm0 0v-160 160ZM760-40v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z"/></svg>
        add question
      <% end %>
      <%= f.button class: "button", type: :button, data: { behaviour: 'show-questions-preview' } do %>
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-480H200v480Zm280-80q-82 0-146.5-44.5T240-440q29-71 93.5-115.5T480-600q82 0 146.5 44.5T720-440q-29 71-93.5 115.5T480-280Zm0-60q56 0 102-26.5t72-73.5q-26-47-72-73.5T480-540q-56 0-102 26.5T306-440q26 47 72 73.5T480-340Zm0-100Zm0 60q25 0 42.5-17.5T540-440q0-25-17.5-42.5T480-500q-25 0-42.5 17.5T420-440q0 25 17.5 42.5T480-380Z"/></svg>
        preview
      <% end %>
    </div>

    <div class="modal">
      <div class="modal__content">
        <div class="card" data-target="questions-preview-wrapper">
        </div>
        <p>click anywhere to close the preview</p>
      </div>
    </div>

    <section data-target="questions-wrapper">
      <%= f.fields_for :questions, @questionnaire.questions.kept do |existing_question_f| %>
        <div class="card question-form">
          <%= existing_question_f.hidden_field :id %>
          <%= existing_question_f.hidden_field :position %>
          <%= existing_question_f.hidden_field :_destroy, value: "0" %>

          <fieldset class="field field--stacked">
            <%= existing_question_f.label :name %>
            <%= existing_question_f.text_field :name %>
          </fieldset>

          <fieldset class="field field--stacked">
            <%= existing_question_f.label :description %>
            <%=
              existing_question_f.text_area :description,
                style: "resize: vertical; min-height: 50px", rows: 1
            %>
          </fieldset>

          <fieldset class="field">
            <%= existing_question_f.label :value_type %>
            <%= existing_question_f.select :value_type, Question.value_types %>
            <span style="color: var(--surface-3);">|</span>
            <%= existing_question_f.check_box :is_emptyable %>
            <%= existing_question_f.label :is_emptyable, class: "checkable" %>
          </fieldset>

          <fieldset class="field actions">
            <%= f.button class: "button", type: :button, data: { behaviour: 'change-question-position-up' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-160v-487L216-423l-56-57 320-320 320 320-56 57-224-224v487h-80Z"/></svg>
              move up
            <% end %>
            <%= f.button class: "button", type: :button, data: { behaviour: 'remove-question-form' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m500-120-56-56 142-142-142-142 56-56 142 142 142-142 56 56-142 142 142 142-56 56-142-142-142 142Zm-220 0v-80h80v80h-80Zm-80-640h-80q0-33 23.5-56.5T200-840v80Zm80 0v-80h80v80h-80Zm160 0v-80h80v80h-80Zm160 0v-80h80v80h-80Zm160 0v-80q33 0 56.5 23.5T840-760h-80ZM200-200v80q-33 0-56.5-23.5T120-200h80Zm-80-80v-80h80v80h-80Zm0-160v-80h80v80h-80Zm0-160v-80h80v80h-80Zm640 0v-80h80v80h-80Z"/></svg>
              remove
            <% end %>
            <%= f.button class: "button", type: :button, data: { behaviour: 'change-question-position-down' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-800v487L216-537l-56 57 320 320 320-320-56-57-224 224v-487h-80Z"/></svg>
              move down
            <% end %>
          </fieldset>
        </div>
      <% end %>
    </section>

    <template data-target="question-form-template">
      <div class="card question-form">
        <%# CHILDIDTEMPLATE will modified by jquery %>
        <%= f.fields_for :questions, @questionnaire.questions.new, child_index: 'CHILDIDTEMPLATE' do |question_f| %>
          <%= question_f.hidden_field :position %>
          <%= question_f.hidden_field :_destroy, value: "0" %>

          <fieldset class="field field--stacked">
            <%= question_f.label :name %>
            <%= question_f.text_field :name %>
          </fieldset>

          <fieldset class="field field--stacked">
            <%= question_f.label :description %>
            <%=
              question_f.text_area :description,
                style: "resize: vertical; min-height: 50px", rows: 1
            %>
          </fieldset>

          <fieldset class="field">
            <%= question_f.label :value_type %>
            <%= question_f.select :value_type, Question.value_types %>
          </fieldset>

          <fieldset class="field">
            <%= question_f.check_box :is_emptyable %>
            <%= question_f.label :is_emptyable, class: "checkable" %>
          </fieldset>

          <fieldset class="field actions">
            <%= f.button class: "button", type: :button, data: { behaviour: 'change-question-position-up' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-160v-487L216-423l-56-57 320-320 320 320-56 57-224-224v487h-80Z"/></svg>
              move up
            <% end %>
            <%= f.button class: "button", type: :button, data: { behaviour: 'remove-question-form' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m500-120-56-56 142-142-142-142 56-56 142 142 142-142 56 56-142 142 142 142-56 56-142-142-142 142Zm-220 0v-80h80v80h-80Zm-80-640h-80q0-33 23.5-56.5T200-840v80Zm80 0v-80h80v80h-80Zm160 0v-80h80v80h-80Zm160 0v-80h80v80h-80Zm160 0v-80q33 0 56.5 23.5T840-760h-80ZM200-200v80q-33 0-56.5-23.5T120-200h80Zm-80-80v-80h80v80h-80Zm0-160v-80h80v80h-80Zm0-160v-80h80v80h-80Zm640 0v-80h80v80h-80Z"/></svg>
              remove
            <% end %>
            <%= f.button class: "button", type: :button, data: { behaviour: 'change-question-position-down' } do %>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-800v487L216-537l-56 57 320 320 320-320-56-57-224 224v-487h-80Z"/></svg>
              move down
            <% end %>
          </fieldset>
        <% end %>
      </div>
    </template>

    <template data-target="question-preview-template">
      <fieldset class="field field--stacked" disabled>
        <p style="display: flex; gap: 2px;"></p>
        <input type="text">
      </fieldset>
    </template>

    <div class="actions">
      <%= f.submit "save questions", class: "button" %>
    </div>
  <% end %>
</div>
